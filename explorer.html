<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Garden Cycles â€¢ Explorer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  * { box-sizing:border-box; }
  body {
    margin:0;
    background:#050608;
    color:#e6e6e6;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    height:100vh;
    display:flex;
    flex-direction:column;
  }
  header {
    padding:10px 16px;
    border-bottom:1px solid #222;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:linear-gradient(90deg,#050608,#0c1510);
  }
  header h1 {
    margin:0;
    font-size:1.2rem;
    color:#8df58d;
  }
  header .controls {
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:8px;
    font-size:0.85rem;
  }
  header a {
    color:#9bf2ff;
    text-decoration:none;
  }
  header a:hover { text-decoration:underline; }

  .chip-btn {
    border:1px solid #2c5;
    background:#050608;
    border-radius:999px;
    padding:4px 10px;
    cursor:pointer;
    color:#b9ffb9;
    font-size:0.8rem;
  }
  .chip-btn:hover {
    background:#132015;
  }

  .container {
    flex:1;
    display:flex;
    min-height:0;
  }
  #sidebar {
    width:260px;
    border-right:1px solid #222;
    padding:10px;
    overflow-y:auto;
    background:#070a0c;
  }
  #content {
    flex:1;
    padding:18px;
    overflow-y:auto;
    position:relative;
    transition: background 0.3s ease, color 0.3s ease;
  }

  #breadcrumbs {
    font-size:0.8rem;
    color:#aaa;
    margin-bottom:10px;
  }
  #breadcrumbs a {
    color:#9bf2ff;
    text-decoration:none;
  }
  #breadcrumbs a:hover { text-decoration:underline; }
  #breadcrumbs strong {
    color:#c0ffc0;
  }

  .fade-in {
    animation: fadeIn 0.25s ease-out;
  }
  @keyframes fadeIn {
    from { opacity:0; transform:translateY(4px); }
    to { opacity:1; transform:translateY(0); }
  }

  .search-box {
    margin-bottom:10px;
  }
  .search-label {
    font-size:0.75rem;
    text-transform:uppercase;
    letter-spacing:0.1em;
    color:#7b9f7b;
    margin-bottom:4px;
  }
  #searchInput {
    width:100%;
    padding:6px 8px;
    border-radius:4px;
    border:1px solid #222;
    background:#050708;
    color:#e6e6e6;
    font-size:0.85rem;
  }
  #searchInput:focus {
    outline:none;
    border-color:#2c5;
  }

  .cycle-title {
    margin:10px 0 4px;
    font-size:0.8rem;
    text-transform:uppercase;
    letter-spacing:0.08em;
    color:#9adf9a;
  }
  .echo-button {
    display:block;
    width:100%;
    text-align:left;
    border:none;
    background:transparent;
    color:#e6e6e6;
    padding:6px 6px;
    margin:1px 0;
    font-size:0.9rem;
    cursor:pointer;
    border-radius:4px;
    transition: background 0.15s ease, color 0.15s ease, transform 0.1s ease;
  }
  .echo-button:hover {
    background:#151b18;
    transform:translateX(1px);
  }
  .echo-button.active {
    background:#1f2a22;
    color:#b9ffb9;
  }

  #content h1, #content h2, #content h3 {
    color:#c0ffc0;
  }
  #content a { color:#9bf2ff; }
  #content a:hover { text-decoration:underline; }
  #content code {
    background:#111;
    padding:0 3px;
    border-radius:3px;
    font-size:0.9em;
  }
  #content pre {
    background:#111;
    padding:10px;
    border-radius:6px;
    overflow-x:auto;
  }
  #status {
    font-size:0.85rem;
    color:#aaa;
    margin-bottom:10px;
  }

  @media (max-width: 900px) {
    #sidebar { width:210px; }
  }
  @media (max-width: 700px) {
    .container { flex-direction:column; }
    #sidebar {
      width:100%;
      border-right:none;
      border-bottom:1px solid #222;
      display:flex;
      flex-direction:column;
    }
  }
</style>
</head>
<body>
<header>
  <h1>ACACIA â€¢ Garden Cycles Explorer</h1>
  <div class="controls">
    <a href="index.html">Codex Home</a> Â·
    <a href="cycle-index.html">Cycle Index</a>
    <button id="randomBtn" class="chip-btn">ðŸŽ² Random Echo</button>
  </div>
</header>

<div class="container">
  <aside id="sidebar">
    <div class="search-box">
      <div class="search-label">Search echoes</div>
      <input id="searchInput" type="text" placeholder="Type to filter by title, label, cycleâ€¦" />
    </div>
    <!-- Echo buttons injected here -->
  </aside>
  <main id="content">
    <div id="breadcrumbs"></div>
    <div id="status">Loading manifestâ€¦</div>
    <p>This explorer reads the manifest and renders each Echo in place.</p>
    <p>Choose a Cycle on the left, or use direct links like:</p>
    <ul>
      <li><code>â€¦/explorer.html#3/acacia</code></li>
      <li><code>â€¦/explorer.html#5/genesis-gaia</code></li>
      <li><code>â€¦/explorer.html#6/remembrance</code></li>
      <li><code>â€¦/explorer.html#7/seed-vault-matrix</code></li>
    </ul>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  let manifest = null;
  let activeButton = null;
  let searchTerm = "";
  const sidebar = document.getElementById('sidebar');
  const content = document.getElementById('content');
  const statusEl = document.getElementById('status');
  const breadcrumbsEl = document.getElementById('breadcrumbs');
  const searchInput = document.getElementById('searchInput');
  const randomBtn = document.getElementById('randomBtn');

  async function loadManifest() {
    try {
      const res = await fetch('cycles/manifest.json');
      if (!res.ok) throw new Error('HTTP ' + res.status);
      manifest = await res.json();
      buildSidebar();
      statusEl.textContent = '';
      restoreFromHash();
    } catch (err) {
      if (statusEl) {
        statusEl.textContent = 'Failed to load manifest.json: ' + err.message;
      }
    }
  }

  function echoMatchesSearch(cycle, echo) {
    if (!searchTerm) return true;
    const term = searchTerm.toLowerCase();
    const haystack = [
      echo.title,
      echo.slug,
      cycle.label || "",
      String(cycle.cycle).padStart(3, '0')
    ].join(' ').toLowerCase();
    return haystack.indexOf(term) !== -1;
  }

  function buildSidebar() {
    // preserve search box DOM, then rebuild list
    const searchBox = sidebar.querySelector('.search-box');
    sidebar.innerHTML = '';
    sidebar.appendChild(searchBox);

    manifest.cycles.forEach(cycle => {
      const matchingEchoes = cycle.echoes.filter(e => echoMatchesSearch(cycle, e));
      if (matchingEchoes.length === 0) return;

      const h = document.createElement('div');
      h.className = 'cycle-title';
      h.textContent = 'Cycle ' + String(cycle.cycle).padStart(3, '0') +
                      (cycle.label ? ' â€“ ' + cycle.label : '');
      sidebar.appendChild(h);

      matchingEchoes.forEach(echo => {
        const btn = document.createElement('button');
        btn.className = 'echo-button';
        btn.textContent = echo.title;
        btn.dataset.cycle = cycle.cycle;
        btn.dataset.slug = echo.slug;
        btn.addEventListener('click', () => selectEcho(cycle.cycle, echo.slug, true, btn));
        sidebar.appendChild(btn);
      });
    });
  }

  async function selectEcho(cycleNum, slug, updateHash = true, btnFromClick = null) {
    if (!manifest) return;
    const cycle = manifest.cycles.find(c => String(c.cycle) === String(cycleNum));
    if (!cycle) {
      if (statusEl) statusEl.textContent = 'Cycle not found: ' + cycleNum;
      return;
    }
    const echo = cycle.echoes.find(e => e.slug === slug);
    if (!echo) {
      if (statusEl) statusEl.textContent = 'Echo not found in cycle ' + cycleNum + ': ' + slug;
      return;
    }

    // highlight in sidebar
    if (!btnFromClick) {
      const selector = '.echo-button[data-cycle="' + cycleNum + '"][data-slug="' + slug + '"]';
      const btn = sidebar.querySelector(selector);
      if (btn) btnFromClick = btn;
    }
    if (activeButton) activeButton.classList.remove('active');
    if (btnFromClick) {
      btnFromClick.classList.add('active');
      activeButton = btnFromClick;
    }

    // breadcrumbs
    setBreadcrumbs(cycle, echo);

    if (statusEl) statusEl.textContent = 'Loading echoâ€¦';
    try {
      const res = await fetch('cycles/' + echo.file);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const md = await res.text();
      const html = marked.parse(md);

      const previousStatus = statusEl ? statusEl.outerHTML : '';
      content.innerHTML = '<div id="breadcrumbs"></div>' + previousStatus + html;
      // re-bind breadcrumbs + status elements after innerHTML reset
      const newStatus = content.querySelector('#status');
      if (newStatus) newStatus.textContent = '';
      breadcrumbsEl = content.querySelector('#breadcrumbs');
      setBreadcrumbs(cycle, echo);

      // trigger fade-in
      content.classList.remove('fade-in');
      void content.offsetWidth; // reflow
      content.classList.add('fade-in');

      if (updateHash) {
        location.hash = cycleNum + '/' + slug;
      }
    } catch (err) {
      content.innerHTML = '<div id="breadcrumbs"></div><p>Failed to load echo: ' + err.message + '</p>';
      const bc = content.querySelector('#breadcrumbs');
      if (bc) setBreadcrumbs(cycle, echo, bc);
    }
  }

  function setBreadcrumbs(cycle, echo, targetEl) {
    const el = targetEl || document.getElementById('breadcrumbs');
    if (!el) return;
    el.innerHTML =
      '<a href="index.html">Home</a> Â· ' +
      '<a href="cycle-index.html">Cycle Index</a> Â· ' +
      '<span>Cycle ' + String(cycle.cycle).padStart(3, '0') + '</span> Â· ' +
      '<strong>' + echo.title + '</strong>';
  }

  function restoreFromHash() {
    const hash = location.hash.replace(/^#/, '');
    if (!hash) return;
    const parts = hash.split('/');
    if (parts.length !== 2) return;
    const cycleNum = parts[0];
    const slug = parts[1];
    selectEcho(cycleNum, slug, false, null);
  }

  function chooseRandomEcho() {
    if (!manifest) return;
    let pool = [];
    manifest.cycles.forEach(cycle => {
      cycle.echoes.forEach(echo => {
        if (echoMatchesSearch(cycle, echo)) {
          pool.push({ cycle, echo });
        }
      });
    });
    if (pool.length === 0) return;
    const choice = pool[Math.floor(Math.random() * pool.length)];
    selectEcho(choice.cycle.cycle, choice.echo.slug, true, null);
  }

  // listeners
  searchInput.addEventListener('input', () => {
    searchTerm = searchInput.value.trim();
    buildSidebar();
  });

  randomBtn.addEventListener('click', chooseRandomEcho);

  window.addEventListener('hashchange', restoreFromHash);
  loadManifest();
</script>
</body>
</html>
