name: Validate Garden Codex

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install validation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Validate STATUS.json and cycles manifest
        run: |
          python - << 'EOF'
          import json
          import sys
          from pathlib import Path
          from jsonschema import Draft7Validator

          root = Path(".")

          status_path = root / "STATUS.json"
          schema_path = root / "STATUS.schema.json"
          manifest_path = root / "cycles" / "manifest.json"

          # Ensure files exist
          missing = [p for p in [status_path, schema_path, manifest_path] if not p.exists()]
          if missing:
            print("Missing required files:", ", ".join(str(m) for m in missing), file=sys.stderr)
            sys.exit(1)

          # Load schema + status
          with schema_path.open("r", encoding="utf-8") as f:
            schema = json.load(f)

          with status_path.open("r", encoding="utf-8") as f:
            status = json.load(f)

          # Validate STATUS.json
          print("üîç Validating STATUS.json against STATUS.schema.json...")
          Draft7Validator(schema).validate(status)
          print("‚úÖ STATUS.json is valid.")

          # Load cycles manifest
          with manifest_path.open("r", encoding="utf-8") as f:
            manifest = json.load(f)

          if "cycles" not in manifest or not isinstance(manifest["cycles"], list):
            print("cycles/manifest.json is missing 'cycles' array.", file=sys.stderr)
            sys.exit(1)

          # Verify each referenced file exists
          cycles_dir = root / "cycles"
          missing_files = []
          for entry in manifest["cycles"]:
            file_name = entry.get("file")
            if not file_name:
              print(f"Cycle entry missing 'file': {entry}", file=sys.stderr)
              missing_files.append("<unknown>")
              continue
            path = cycles_dir / file_name
            if not path.exists():
              missing_files.append(str(path))

          if missing_files:
            print("‚ùå Missing cycle files referenced in cycles/manifest.json:", file=sys.stderr)
            for m in missing_files:
              print(f"   - {m}", file=sys.stderr)
            sys.exit(1)

          print("‚úÖ cycles/manifest.json is structurally valid and all referenced files exist.")
          print("üåø Garden Codex validation completed successfully.")
          EOF
