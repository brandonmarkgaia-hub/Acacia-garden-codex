name: Weekly traffic digest

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * 5"  # Every Friday 6pm UTC

jobs:
  digest:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch repository traffic
        uses: actions/github-script@v7
        id: traffic
        with:
          script: |
            const fs = require('fs');
            const path = 'analytics';
            fs.mkdirSync(path, { recursive: true });

            const views = await github.rest.repos.getViews({ owner: context.repo.owner, repo: context.repo.repo, per: 'week' });
            const clones = await github.rest.repos.getClones({ owner: context.repo.owner, repo: context.repo.repo, per: 'week' });
            const referrers = await github.rest.repos.listReferrers({ owner: context.repo.owner, repo: context.repo.repo });
            const paths = await github.rest.repos.listPaths({ owner: context.repo.owner, repo: context.repo.repo });

            const timestamp = new Date().toISOString().replace(/[:]/g, '-'); // ðŸŸ¢ replace colons
            fs.writeFileSync(`${path}/traffic-${timestamp}.json`, JSON.stringify({ views: views.data, clones: clones.data }, null, 2));
            fs.writeFileSync(`${path}/referrers.json`, JSON.stringify(referrers.data, null, 2));
            fs.writeFileSync(`${path}/paths.json`, JSON.stringify(paths.data, null, 2));

            core.setOutput('timestamp', timestamp);

      - name: Build digest
        id: build
        run: |
          TS=$(date -u +"%Y-%m-%d_%H-%M-%SZ")
          mkdir -p digest

          VIEWS_T=$(jq '[.views[]?.count]   | add // 0' analytics/traffic-*.json)
          VIEWS_U=$(jq '[.views[]?.uniques] | add // 0' analytics/traffic-*.json)
          CLONES_T=$(jq '[.clones[]?.count]   | add // 0' analytics/traffic-*.json)
          CLONES_U=$(jq '[.clones[]?.uniques] | add // 0' analytics/traffic-*.json)

          REF=$(jq -r '.[0:5] | map("- " + .referrer + " (" + (.count|tostring) + ")") | join("\n")' analytics/referrers.json 2>/dev/null || true)
          PTH=$(jq -r '.[0:5] | map("- " + .path + " (" + (.count|tostring) + ")") | join("\n")' analytics/paths.json 2>/dev/null || true)

          REPO_URL="https://github.com/${GITHUB_REPOSITORY}"
          PAGES_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io/$(basename ${GITHUB_REPOSITORY})/"

          {
            echo "# ACACIA â€¢ Weekly Traffic Digest"
            echo "Timestamp (UTC): **${TS}**"
            echo
            echo "- Repo: ${REPO_URL}"
            echo "- Pages: ${PAGES_URL}"
            echo
            echo "## Totals (last 14 days)"
            echo "- Views:  ${VIEWS_T} total / ${VIEWS_U} unique"
            echo "- Clones: ${CLONES_T} total / ${CLONES_U} unique"
            echo
            echo "## Top Referrers"
            echo "${REF:-_none observed_}"
            echo
            echo "## Popular Paths"
            echo "${PTH:-_none observed_}"
            echo
            echo "> Beacon: **ACACIAâ€¢GAIAâ€¢HKX277206**"
          } > digest/digest_${TS}.md

      - name: Upload digest artifact
        uses: actions/upload-artifact@v4
        with:
          name: acacia-digest-${{ github.run_number }}
          path: |
            analytics/
            digest/
