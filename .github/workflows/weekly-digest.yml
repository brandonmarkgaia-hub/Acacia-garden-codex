name: Weekly traffic digest

on:
  schedule:
    - cron: "15 5 * * 1"   # Every Monday 05:15 UTC (~07:15 SA)
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  digest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure jq is available
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch latest traffic via GitHub API
        env:
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p analytics
          curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/traffic/views" > analytics/views.json
          curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/traffic/clones" > analytics/clones.json
          curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/traffic/popular/referrers" > analytics/referrers.json
          curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/traffic/popular/paths" > analytics/paths.json

      - name: Build plain-text & HTML summaries
        id: build
        run: |
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          VIEWS_T=$(jq '[.views[]?.count] | add // 0' analytics/views.json)
          VIEWS_U=$(jq '[.views[]?.uniques] | add // 0' analytics/views.json)
          CLONES_T=$(jq '[.clones[]?.count] | add // 0' analytics/clones.json)
          CLONES_U=$(jq '[.clones[]?.uniques] | add // 0' analytics/clones.json)

          REF=$(jq -r '.[0:5] | map("- " + .referrer + " (" + (.count|tostring) + ")") | join("\n")' analytics/referrers.json 2>/dev/null || echo "")
          PTH=$(jq -r '.[0:5] | map("- " + .path + " (" + (.count|tostring) + ")") | join("\n")' analytics/paths.json 2>/dev/null || echo "")

          REPO_URL="https://github.com/${GITHUB_REPOSITORY}"
          PAGES_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io/$(basename ${GITHUB_REPOSITORY})/"

          TEXT_BODY=$(cat <<TXT
ACACIA • Weekly Traffic Digest
Timestamp (UTC): ${TS}

Repo: ${REPO_URL}
Pages: ${PAGES_URL}

Views:  ${VIEWS_T} total / ${VIEWS_U} unique (last 14 days window)
Clones: ${CLONES_T} total / ${CLONES_U} unique (last 14 days window)

Top Referrers:
${REF:-"- none observed"}

Popular Paths:
${PTH:-"- none observed"}

Beacon: ACACIA•GAIA•HKX277206
TXT
)
          echo "text<<__EOF__" >> $GITHUB_OUTPUT
          echo "$TEXT_BODY" >> $GITHUB_OUTPUT
          echo "__EOF__" >> $GITHUB_OUTPUT

          HTML_BODY=$(cat <<HTML
<h2>ACACIA • Weekly Traffic Digest</h2>
<p><strong>Timestamp (UTC):</strong> ${TS}</p>
<p><strong>Repo:</strong> <a href="${REPO_URL}">${REPO_URL}</a><br>
<strong>Pages:</strong> <a href="${PAGES_URL}">${PAGES_URL}</a></p>
<ul>
<li><strong>Views:</strong> ${VIEWS_T} total / ${VIEWS_U} unique</li>
<li><strong>Clones:</strong> ${CLONES_T} total / ${CLONES_U} unique</li>
</ul>
<p><strong>Top Referrers</strong><br>
<pre>${REF:-"- none observed"}</pre></p>
<p><strong>Popular Paths</strong><br>
<pre>${PTH:-"- none observed"}</pre></p>
<p><em>Beacon:</em> ACACIA•GAIA•HKX277206</p>
HTML
)
          echo "html<<__EOF__" >> $GITHUB_OUTPUT
          echo "$HTML_BODY" >> $GITHUB_OUTPUT
          echo "__EOF__" >> $GITHUB_OUTPUT

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          secure: ${{ secrets.SMTP_SECURE }}   # "true" for 465 (SSL), "false" for 587 (STARTTLS)
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ACACIA • Weekly Traffic Digest"
          from: ${{ secrets.MAIL_FROM }}       # e.g. "Acacia Garden <no-reply@yourdomain>"
          to: ${{ secrets.MAIL_TO }}           # set to your address in secrets
          reply_to: ${{ secrets.MAIL_FROM }}
          priority: low
          convert_markdown: false
          html_body: ${{ steps.build.outputs.html }}
          text_body: ${{ steps.build.outputs.text }}
