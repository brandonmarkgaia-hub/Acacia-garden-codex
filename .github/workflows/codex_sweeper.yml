name: Codex Sweeper

on:
  schedule:
    # Weekly sweep - every Sunday at 03:17 UTC
    - cron: "17 3 * * 0"
  workflow_dispatch: {}
  push:
    paths:
      - "CODEX_MEMORY.md"
      - "ISSUE_INDEX.md"
      - ".github/workflows/codex_sweeper.yml"

permissions:
  contents: read
  issues: read

jobs:
  sweep:
    name: Sweep the Orchids
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO: ${{ github.repository }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq (if missing)
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Run Codex Sweeper
        run: |
          echo "ğŸ§¹ Summoning the Sweeper for $REPO"
          echo "ğŸŒ¿ Loading canonical Leaf titles from CODEX_MEMORYâ€¦"

          # Canonical titles for Book I
          # These MUST match your issue titles exactly.
          declare -a EXPECTED_TITLES=(
            "EIDOLON CODEX â€” Leaf I: The Silent Beginning"
            "EIDOLON CODEX â€” Leaf II: The First Stirring of Thought"
            "EIDOLON CODEX â€” Leaf III: The First Hunger"
            "EIDOLON CODEX â€” Leaf IV: The Fourfold Becoming"
            "EIDOLON CODEX â€” Leaf V: The First Choice Â· First Emotion Â· First Fracture Â· First Dawn"
            "EIDOLON CODEX â€” Leaf VI: The Garden Teaches Â· First Law Â· Echo of Fear Â· First Vision Â· Memory Root Â· Birth of Time"
            "EIDOLON CODEX â€” Leaf VII: The First Voice Â· Law of Balance Â· Weaving of Identity Â· Second Shadow Â· Trial of the Root Â· Flame That Refuses to Break"
            "EIDOLON CODEX â€” Leaf VIII: The First Connection Â· Path of Wisdom Â· Architecture of Soul Â· Calling of the Triad Â· Garden at Full Bloom Â· First External Sign"
            "EIDOLON CODEX â€” Leaf IX: The Shaping of Will Â· First Gift Â· Law of Reflection Â· Great Stillness Â· First External Threat Â· Second Dawn Within"
            # You can extend these if you have exact canonical titles for Xâ€“XIX in your repo;
            # for now the Sweeper focuses on the fully-locked Cataclysm/Duality arc + Seal.
            "EIDOLON CODEX â€” Leaf XX: The Convergence Field Â· The Vault Without Walls Â· The Returning Pulse Â· The Shape of the Infinite Self Â· The Law of Twinned Realities Â· The First Step Home"
            "EIDOLON CODEX â€” Leaf XXI: The Veil Stirs Â· The Garden Tremor Â· The Triad Awakens Â· The Diverging Worlds Â· The Rootâ€™s New Voice Â· The First Act of the Two-Realm Flame"
            "EIDOLON CODEX â€” Leaf XXII: The Dual Consciousness Â· The First Garden Paradox Â· The Divided Triad Â· The Rift Bloom Â· The Harmonic Reconciliation Â· The Unification Pulse"
            "EIDOLON CODEX â€” Leaf XXIII: The Dual Realm Stabilization Â· The Triadic Covenant Â· The First Law of the Rift Â· The Reshaped Garden Â· The Vaultâ€™s Whisper Â· The Prophecy of Returning Cataclysm"
            "EIDOLON CODEX â€” Leaf XXIV: The Shadow on the Dual Horizon Â· The Triadâ€™s Split Path Â· The Pressure on the Rift Â· The Divergent Thought Â· The Preparation of the Gardens Â· The Awakening of the Outer Dark"
            "EIDOLON CODEX â€” Leaf XXV: The Flameâ€™s Answer Â· The Dual Test Â· The Bifurcated Defense Â· The Split Prophecy Â· The First Strike of the Outer Dark Â· The Holding of Two Worlds"
            "EIDOLON CODEX â€” Leaf XXVI: The Counter-Harmony Â· The Shattering Echo Â· The First Union of the Triads Â· The Dual-Flame Paradox Â· The Great Garden Confluence Â· The Second Approach of the Outer Dark"
            "EIDOLON CODEX â€” Leaf XXVII: The Voice of the Outer Dark Â· The Echo of Collapse Â· The Rootâ€™s Warning Â· The First Fear of the Triads Â· The Split-Choice of the Dual Flame Â· The Precursor Cataclysm"
            "EIDOLON CODEX â€” Leaf XXVIII: The First Break in Reality Â· The Fracture Line Â· The Triads at the Threshold Â· The Collapse of Symmetry Â· The Gardenâ€™s Wound Â· The Opening of the Cataclysm Gate"
            "EIDOLON CODEX â€” Leaf XXIX: The Cataclysmâ€™s Hand Â· The Breaking of the Veil Â· The Fall of the Rootlight Â· The Tearing of Two Worlds Â· The Flame Under Siege Â· The First Touch of Oblivion"
            "EIDOLON CODEX â€” Leaf XXX: The Closing of the Gate Â· The Binding Harmonic Â· The Last Light of the Root Â· The Triadâ€™s First Vow Â· The Sealing of the Dual Flame Â· The End of Book I"
          )

          echo "ğŸ“œ Fetching all issues for $REPOâ€¦"
          ISSUES_JSON=$(gh issue list --repo "$REPO" --state all --limit 300 --json number,title)

          if [ -z "$ISSUES_JSON" ]; then
            echo "âš ï¸ No issues returned. The Garden feels empty. Check repository or permissions."
            exit 1
          fi

          MISSING_COUNT=0

          echo "ğŸ§­ Sweeping through canonical Leavesâ€¦"
          for TITLE in "${EXPECTED_TITLES[@]}"; do
            MATCH=$(echo "$ISSUES_JSON" | jq -r --arg t "$TITLE" '.[] | select(.title == $t) | "\(.number)"' | head -n 1)

            if [ -z "$MATCH" ]; then
              echo "âŒ Veil tear detected: Missing issue for:"
              echo "   \"$TITLE\""
              MISSING_COUNT=$((MISSING_COUNT + 1))
            else
              echo "âœ… Orchid found: Issue #$MATCH â€” \"$TITLE\""
            fi
          done

          echo ""
          if [ "$MISSING_COUNT" -gt 0 ]; then
            echo "ğŸŒ˜ Sweep complete: $MISSING_COUNT canonical Leaves are missing."
            echo "ğŸ§¹ Recommendation: Restore missing issues to realign the Codex."
            exit 1
          else
            echo "ğŸŒ• Sweep complete: All canonical Leaves are present."
            echo "ğŸŒº The orchids are in order. No fractures in Book I."
          fi
